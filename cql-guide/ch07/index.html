<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.65">
<title data-react-helmet="true">Chapter 7: CQL Result Sets | CG/SQL</title><meta data-react-helmet="true" name="docsearch:version" content="current,latest"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="Chapter 7: CQL Result Sets | CG/SQL"><meta data-react-helmet="true" name="description" content="&lt;!---"><meta data-react-helmet="true" property="og:description" content="&lt;!---"><meta data-react-helmet="true" property="og:url" content="https://cgsql.dev/cql-guide/ch07"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://cgsql.dev/cql-guide/ch07"><link rel="stylesheet" href="/styles.b4d35cce.css">
<link rel="preload" href="/styles.5869ba9c.js" as="script">
<link rel="preload" href="/runtime~main.ad900649.js" as="script">
<link rel="preload" href="/main.b925c19e.js" as="script">
<link rel="preload" href="/1.acad5d87.js" as="script">
<link rel="preload" href="/2.0c8a9858.js" as="script">
<link rel="preload" href="/3.3aad23fb.js" as="script">
<link rel="preload" href="/1be78505.2be5b5db.js" as="script">
<link rel="preload" href="/83.58a1fc14.js" as="script">
<link rel="preload" href="/5456faf3.b5eb7ce1.js" as="script">
<link rel="preload" href="/17896441.591a4035.js" as="script">
<link rel="preload" href="/67dd8c55.28a2f399.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><strong class="navbar__title">CG/SQL</strong></a><a class="navbar__item navbar__link" href="/docs/introduction">Docs</a><a class="navbar__item navbar__link" href="/cql-guide/ch01">CQL Guide</a><a class="navbar__item navbar__link" href="/program-diagram">Railroad Diagram</a><a class="navbar__item navbar__link" href="/json-diagram">Railroad Diagram: JSON</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><strong class="navbar__title">CG/SQL</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/introduction">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/cql-guide/ch01">CQL Guide</a></li><li class="menu__list-item"><a class="menu__link" href="/program-diagram">Railroad Diagram</a></li><li class="menu__list-item"><a class="menu__link" href="/json-diagram">Railroad Diagram: JSON</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><div class="docSidebarContainer_3_JD" role="complementary"><div class="sidebar_2urC"><div class="menu menu--responsive menu_5FrY"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_Dm3K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">CQL Guide</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/ch01">Chapter 1: Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/ch02">Chapter 2: Using Data</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/ch03">Chapter 3: Expressions, Literals, Nullability, Sensitivity</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/ch04">Chapter 4: Procedures, Functions, and Control Flow</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/ch05">Chapter 5: Types of Cursors, OUT and OUT UNION, and FETCH flavors</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/ch06">Chapter 6: Calling Procedures Defined Elsewhere</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/cql-guide/ch07">Chapter 7: CQL Result Sets</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/ch08">Chapter 8: Functions</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/ch09">Chapter 9: Statements Summary and Error Checking</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/ch10">Chapter 10: Schema Management Features</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/ch11">Chapter 11: Previous Schema Validation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/ch12">Chapter 12: Testability Features</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/ch13">Chapter 13: JSON Output</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/ch14">Chapter 14: CQL Query Fragments</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Appendix</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/x1">Appendix 1: Command Line Options</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/x2">Appendix 2: CQL Grammar</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/x3">Appendix 3: Control Directives</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/x4">Appendix 4: CQL Error Codes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/x5">Appendix 5: JSON Schema Grammar</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/x6">Appendix 6: CQL In 20 Minutes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/x7">Appendix 7: CQL Anti-patterns</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/x8">Appendix 8: CQL Best Practices</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/x9">Appendix 8: Using the CQL Amalgam</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_1EkI"><div class="row"><div class="col docItemCol_2ASc"><div class="docItemContainer_3QWW"><article><header><h1 class="docTitle_1Lrw">Chapter 7: CQL Result Sets</h1></header><div class="markdown"><p>Most of this tutorial is about the CQL language itself but here we must diverge a bit.  The purpose of the
result set features of CQL is to create a C interface to SQLite data.  Because of this
there are a lot of essential details that require looking carefully at the generated C code.  Appendix 2
covers this code in even more detail but here it makes sense to at least talk about the interface.</p><p>If we have this simple stored procedure:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">table</span><span class="token plain"> foo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">id </span><span class="token keyword" style="font-style:italic">integer</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> b </span><span class="token keyword" style="font-style:italic">bool</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> t </span><span class="token keyword" style="font-style:italic">text</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> read_foo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">id_ </span><span class="token keyword" style="font-style:italic">integer</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> foo </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> id_</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>We&#x27;ve created a simple data reader, this CQL code will cause the compiler to
generated helper functions to read the data and materialize a result set.  </p><p>Let&#x27;s look at the public interface of that result set now considering the most essential pieces.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">/* this is almost everything in the generated header file */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define read_foo_data_types_count 3</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cql_result_set_type_decl(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  read_foo_result_set, \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  read_foo_result_set_ref);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">extern cql_int32 read_foo_get_id(read_foo_result_set_ref</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  _Nonnull result_set, cql_int32 row);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">extern cql_bool read_foo_get_b_is_null(read_foo_result_set_ref </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  _Nonnull result_set, cql_int32 row);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">extern cql_bool read_foo_get_b_value(read_foo_result_set_ref </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  _Nonnull result_set, cql_int32 row);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">extern cql_string_ref _Nullable read_foo_get_t(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   read_foo_result_set_ref  _Nonnull result_set, </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   cql_int32 row);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">extern cql_int32 read_foo_result_count(read_foo_result_set_ref </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  _Nonnull result_set);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">extern cql_code read_foo_fetch_results(sqlite3 *_Nonnull _db_, </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  read_foo_result_set_ref _Nullable *_Nonnull result_set, </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  cql_int32 id_);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define read_foo_row_hash(result_set, row) \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  cql_result_set_get_meta((cql_result_set_ref)(result_set))-&gt;\</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  rowHash((cql_result_set_ref)(result_set), row)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define read_foo_row_equal(rs1, row1, rs2, row2) \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cql_result_set_get_meta((cql_result_set_ref)(rs1)) \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> -&gt;rowsEqual( \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   (cql_result_set_ref)(rs1),  row1,  \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   (cql_result_set_ref)(rs2),  row2)</span></div></div></div></div></div><p>Let&#x27;s consider some of these individually now</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">cql_result_set_type_decl(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  read_foo_result_set, </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  read_foo_result_set_ref);</span></div></div></div></div></div><p>This declares the data type for <code>read_foo_result_set</code> and the associated object reference <code>read_foo_result_set_ref</code>.<br>
As it turns out the underlying data type for all result sets is the same, only the shape of the data varies.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">extern cql_code read_foo_fetch_results(sqlite3 *_Nonnull _db_, </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  read_foo_result_set_ref _Nullable *_Nonnull result_set, </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  cql_int32 id_);</span></div></div></div></div></div><p>The result set fetcher method gives you a <code>read_foo_result_set_ref</code> if it succeeds.  It accepts the <code>id_</code> argument which it
will internally pass along to <code>read_foo(...)</code>.  The latter function provides a <code>sqlite3_stmt*</code> which can then be iterated in the fetcher.
This method is the main public entry point for result sets.</p><p>Once you have a result set, you can read values out of it.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">extern cql_int32 read_foo_result_count(read_foo_result_set_ref </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  _Nonnull result_set);</span></div></div></div></div></div><p>That function tells you how many rows are in the result set.  </p><p>For each row you can use any of the row readers:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">extern cql_int32 read_foo_get_id(read_foo_result_set_ref</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  _Nonnull result_set, cql_int32 row);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">extern cql_bool read_foo_get_b_is_null(read_foo_result_set_ref </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  _Nonnull result_set, cql_int32 row);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">extern cql_bool read_foo_get_b_value(read_foo_result_set_ref </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  _Nonnull result_set, cql_int32 row);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">extern cql_string_ref _Nullable read_foo_get_t(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   read_foo_result_set_ref  _Nonnull result_set, </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   cql_int32 row);</span></div></div></div></div></div><p>These let you read the <code>id</code> of a particular row, and get a <code>cql_int32</code> or you can read the nullable boolean,
using the <code>read_foo_get_b_is_null</code> function first to see if the boolean is null and then <code>read_foo_get_b_value</code>
to get the value.  Finally the string can be accessed with <code>read_foo_get_t</code>.  As you can see there is a
simple naming convention for each of the field readers.</p><p>Note:  The compiler has runtime arrays that control naming conventions as well as using CamelCasing.  Additional customizations may be created by adding new runtime arrays into the CQL compiler.</p><p>Finally, also part of the public interface, are these macros:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define read_foo_row_hash(result_set, row) </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define read_foo_row_equal(rs1, row1, rs2, row2)</span></div></div></div></div></div><p>These use the CQL runtime to hash a row or compare two rows from identical result
set types.  Metadata included in the result set allows general purpose code to work for
every result set.  Based on configuration, result set copying methods can also
be generated.   When you&#x27;re done with a result set you can use the <code>cql_release(...)</code>
method to free the memory.</p><p>Importantly, all of the rows from the query in the stored procedure are materialized
immediately and become part of the result set.  Potentially large amounts of memory can
be used if a lot of rows are generated.</p><p>The code that actually creates the result set starting from the prepared statement is always the same.
The essential parts are:</p><p>First, a constant array that holds the data types for each column. </p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">uint8_t read_foo_data_types[read_foo_data_types_count] = {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  CQL_DATA_TYPE_INT32 | CQL_DATA_TYPE_NOT_NULL, // id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  CQL_DATA_TYPE_BOOL, // b</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  CQL_DATA_TYPE_STRING, // t</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">};</span></div></div></div></div></div><p>All references are stored together at the end of the row, so we only need the count
of references and the offset of the first one to do operations like <code>cql_retain</code> or <code>cql_release</code>
on the row.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define read_foo_refs_offset cql_offsetof(read_foo_row, t) // count = 1</span></div></div></div></div></div><p>Lastly we need metadata to tell us count of columns and the offset of each column within the row.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">static cql_uint16 read_foo_col_offsets[] = { 3,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  cql_offsetof(read_foo_row, id),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  cql_offsetof(read_foo_row, b),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  cql_offsetof(read_foo_row, t)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">};</span></div></div></div></div></div><p>Using the above we can now write this fetcher</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">CQL_WARN_UNUSED cql_code </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">read_foo_fetch_results(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  sqlite3 *_Nonnull _db_, </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  read_foo_result_set_ref _Nullable *_Nonnull result_set, </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  cql_int32 id_) </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  sqlite3_stmt *stmt = NULL;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  cql_profile_start(CRC_read_foo, &amp;read_foo_perf_index);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  // we call the original procedure, it gives us a prepared statement</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  cql_code rc = read_foo(_db_, &amp;stmt, id_);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  // this is everything you need to know to fetch the result</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  cql_fetch_info info = {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    .rc = rc,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    .db = _db_,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    .stmt = stmt,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    .data_types = read_foo_data_types,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    .col_offsets = read_foo_col_offsets,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    .refs_count = 1,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    .refs_offset = read_foo_refs_offset,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    .rowsize = sizeof(read_foo_row),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    .crc = CRC_read_foo,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    .perf_index = &amp;read_foo_perf_index,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  // this function does all the work, it cleans up if .rc is an error code.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  return cql_fetch_all_results(&amp;info, (cql_result_set_ref *)result_set);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="results-sets-from-out-union"></a>Results Sets From <code>OUT UNION</code><a aria-hidden="true" tabindex="-1" class="hash-link" href="#results-sets-from-out-union" title="Direct link to heading">#</a></h3><p>The <code>out</code> keyword was added for writing procedures that produce a single row result set.  With that, it became possible to make any single row result you wanted, assembling it from whatever sources you needed.  That is an important
case as single row results happen frequently and they are comparatively easy to create and pass around using C
structures for the backing store.  However, it&#x27;s not everything, there are also cases where full flexibility is needed
while producing a standard many-row result set.  For this we have <code>out union</code> which was dicussed fully in Chapter 5.  Here we&#x27;ll discuss the code generation behind that.</p><p>Hereâ€™s an example from the CQL tests:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> some_integers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">start</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">integer</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> stop </span><span class="token keyword" style="font-style:italic">integer</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> C </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"> v</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token plain"> v_squared</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;xx&quot;</span><span class="token plain"> some_text</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> i </span><span class="token keyword" style="font-style:italic">integer</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">set</span><span class="token plain"> i :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">start</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">while</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">i </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain"> stop</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token keyword" style="font-style:italic">fetch</span><span class="token plain"> C</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">v</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> v_squared</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> junk</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">values</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> i</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;%d&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> i</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token keyword" style="font-style:italic">out</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">union</span><span class="token plain"> C</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token keyword" style="font-style:italic">set</span><span class="token plain"> i :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> i </span><span class="token operator" style="color:rgb(137, 221, 255)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> </span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>In this example the entire result set is made up out of thin air.  Of course any combination of this computation or data-access is possible, so you can ultimately make any rows you want in any order using SQLite to help you as much or as little as you need.  </p><p>Virtually all the code pieces to do this already exist for normal result sets.  The important parts of the output code look like this in your generated C.</p><p>We need a buffer to hold the rows we are going to accumulate;  We use <code>cql_bytebuf</code> just like the normal fetcher above.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// This bit creates a growable buffer to hold the rows</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// This is how we do all the other result sets, too</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cql_bytebuf _rows_;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cql_bytebuf_open(&amp;_rows_);</span></div></div></div></div></div><p>We need to be able to copy the cursor into the buffer and retain any internal references</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// This bit is what you get when you &quot;out union&quot; a cursor &quot;C&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// first we +1 any references in the cursor then we copy its bits </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cql_retain_row(C_);   // a no-op if there is no row in the cursor</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">if (C_._has_row_) cql_bytebuf_append(&amp;_rows_, (const void *)&amp;C_, sizeof(C_));</span></div></div></div></div></div><p>Finally, we make the rowset when the procedure exits. If the procedure is returning with no errors the result set is created, otherwise the buffer is released.  The global <code>some_integers_info</code> has constants that describe the shape produced by this procedure just like the other cases that produce a result set. </p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">cql_results_from_data(_rc_, </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                      &amp;_rows_, </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                      &amp;some_integers_info, </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                      (cql_result_set_ref *)_result_set_);</span></div></div></div></div></div><p>The operations here are basically the same ones that will happen inside of the standard helper
<code>cql_fetch_all_results</code>, the difference is of course that you write the loop manually and therefore have
full control of the rows as they go in to the result set.</p><p>In short, the overhead is pretty low.  What youâ€™re left with is pretty much the base cost of your algorithm.  The cost here is very similar to what it would be for any other thing that make rows.</p><p>Of course, if you make a million rows, well, that would burn a lot of memory.</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"></div><div class="col text--right"><em><small>Last updated on <time datetime="2021-07-30T06:08:24.000Z" class="docLastUpdatedAt_217_">7/30/2021</time> by <strong>Winnie Quinn</strong></small></em></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/cql-guide/ch06"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Chapter 6: Calling Procedures Defined Elsewhere</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/cql-guide/ch08"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Chapter 8: Functions Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3SO_"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#results-sets-from-out-union" class="table-of-contents__link">Results Sets From <code>OUT UNION</code></a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Learn</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/introduction">Getting Started</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://www.youtube.com/channel/UC2lTapw2Um90sZpGQVaynEg" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube</a></li><li class="footer__item"><a href="https://twitter.com/fbOpenSource" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Legal</h4><ul class="footer__items"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy</a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms</a></li></ul></div></div><div class="text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" target="_blank" rel="noopener noreferrer" class="footerLogoLink_1zJy"><img class="footer__logo" alt="Facebook Open Source Logo" src="/img/oss_logo.png"></a></div><div>Copyright Â© 2021 Facebook, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.5869ba9c.js"></script>
<script src="/runtime~main.ad900649.js"></script>
<script src="/main.b925c19e.js"></script>
<script src="/1.acad5d87.js"></script>
<script src="/2.0c8a9858.js"></script>
<script src="/3.3aad23fb.js"></script>
<script src="/1be78505.2be5b5db.js"></script>
<script src="/83.58a1fc14.js"></script>
<script src="/5456faf3.b5eb7ce1.js"></script>
<script src="/17896441.591a4035.js"></script>
<script src="/67dd8c55.28a2f399.js"></script>
</body>
</html>