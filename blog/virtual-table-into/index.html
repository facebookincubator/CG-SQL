<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.65">
<title data-react-helmet="true">Introducing Virtual Tables | CG/SQL</title><meta data-react-helmet="true" property="og:title" content="Introducing Virtual Tables | CG/SQL"><meta data-react-helmet="true" name="description" content="Language support for virtual tables has lagged since I always thought they were of little interest to"><meta data-react-helmet="true" property="og:description" content="Language support for virtual tables has lagged since I always thought they were of little interest to"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/styles.4959ceee.css">
<link rel="preload" href="/styles.cf675315.js" as="script">
<link rel="preload" href="/runtime~main.638623f9.js" as="script">
<link rel="preload" href="/main.6b85c48e.js" as="script">
<link rel="preload" href="/1.faa8ac5d.js" as="script">
<link rel="preload" href="/2.f1f5104c.js" as="script">
<link rel="preload" href="/3.7dcf5e64.js" as="script">
<link rel="preload" href="/ccc49370.284a7f8d.js" as="script">
<link rel="preload" href="/ffbd8a12.0bf7db55.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><strong class="navbar__title">CG/SQL</strong></a><a class="navbar__item navbar__link" href="/docs/introduction">Docs</a><a class="navbar__item navbar__link" href="/cql-guide/ch01">CQL Guide</a><a class="navbar__item navbar__link" href="/cql-guide/int01">CQL Internals</a><a class="navbar__item navbar__link" href="/program-diagram">Railroad Diagram</a><a class="navbar__item navbar__link" href="/json-diagram">Railroad Diagram: JSON</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><strong class="navbar__title">CG/SQL</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/introduction">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/cql-guide/ch01">CQL Guide</a></li><li class="menu__list-item"><a class="menu__link" href="/cql-guide/int01">CQL Internals</a></li><li class="menu__list-item"><a class="menu__link" href="/program-diagram">Railroad Diagram</a></li><li class="menu__list-item"><a class="menu__link" href="/json-diagram">Railroad Diagram: JSON</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--8 col--offset-2"><article><header><h1 class="margin-bottom--sm blogPostTitle_1mse">Introducing Virtual Tables</h1><div class="margin-vert--md"><time datetime="2020-12-16T00:00:00.000Z" class="blogPostDate_3bQP">December 16, 2020  Â· 5 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener"><img src="https://avatars2.githubusercontent.com/u/69631?s=200&amp;v=4" alt="CG/SQL Team"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener">CG/SQL Team</a></h4><small class="avatar__subtitle">Maintainer of CG/SQL</small></div></div></header><section class="markdown"><p>Language support for virtual tables has lagged since I always thought they were of little interest to
the language anyway. The <code>CREATE TABLE</code> forms in general are only declarations (except if you&#x27;re doing
the schema installer/upgrader output) and so you could just declare say a temp table that corresponds to the
virtual table that you made in the same way that you might declare say <code>sqlite_master</code> if you wanted to use it.
And since you have to register the module anyway, you may as well create the virtual table at the same time.</p><p>So there was no point in adding language support for the thing.</p><p>Furthermore the <code>CREATE VIRTUAL TABLE</code> form includes no information about the schema of the table so you&#x27;d
need some kind of declaration anyway in order to tell the language what the columns are for the table you
just created.  So again you may as well just declare it like a normal table and not include that table in your
schema upgrade file and be done with it.</p><p>And that was my thinking for the last 2 years. And then I learned something.</p><p>Virtual tables are durable.</p><p>Yeah, I always assumed that virtual tables were temp tables and they vanish and have to be redeclared every
session but that is not the case.  They are part of the durable schema so while you must pre-register the
module associated with the virtual table, the virtual table is like other tables in that you only create it
once and from then on it&#x27;s part of the schema every time the database loads until you <code>DROP</code> it.</p><p>This changes everything.</p><p>With virtual tables being durable they belong in the schema upgrade process.  And if they go there they also
have to go into the JSON output.  But we can&#x27;t use the vanilla syntax that SQLite uses because that syntax is:</p><ul><li>not parseable, because the module arguments can be literally anything (or nothing), even a letter to your grandma.</li><li>the arguments do not necessarily say anything about the table&#x27;s schema at all</li></ul><p>So in the CQL language I change the syntax a bit, the generalized form looks like this:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">create virtual table virt_table using my_module [(module arguments)]  as (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  id integer not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name text</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">);</span></div></div></div></div></div><p>The part after the <code>AS</code> is used by CQL as a table declaration for the virtual table.  The grammar for that
is exactly the same as a normal <code>CREATE TABLE</code> statement.  However that part is not transmitted to
SQLite; when the table is created, SQLite sees only the part it cares about, the part before the <code>AS</code>.</p><p>Now this leaves the module arguments, they can be one of three things:</p><ol><li>no arguments at all</li><li>a list of identifiers, constants, and parenthesized sublists just like in the <code>@attribute</code> form</li><li>the words <code>arguments following</code></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="case-1-example"></a>Case 1 Example<a aria-hidden="true" tabindex="-1" class="hash-link" href="#case-1-example" title="Direct link to heading">#</a></h3><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">create virtual table virt_table using my_module as (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  id integer not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name text</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">);</span></div></div></div></div></div><p>becomes (to SQLite)</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE TABLE virt_table USING my_module;</span></div></div></div></div></div><p>Note: empty arguments <code>USING my_module()</code> are not allowed in the SQLite docs but do seem to work in SQLite.
We take the position that no args should be done with no parens, at least for now.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="case-2-example"></a>Case 2 Example<a aria-hidden="true" tabindex="-1" class="hash-link" href="#case-2-example" title="Direct link to heading">#</a></h3><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">create virtual table virt_table using my_module(foo, &#x27;goo&#x27;, (1.5, (bar, baz))) as (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  id integer not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name text</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">);</span></div></div></div></div></div><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE VIRTUAL TABLE virt_table USING my_module(foo, &quot;goo&quot;, (1.5, (bar, baz)));</span></div></div></div></div></div><p>This form allows for very flexible arguments but not totally arbitrary arguments, so it can still be
parsed and validated.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="case-3-example"></a>Case 3 Example<a aria-hidden="true" tabindex="-1" class="hash-link" href="#case-3-example" title="Direct link to heading">#</a></h3><p>This case recognizes the popular choice that the arguments are often the actual schema declaration
for the table in question. So</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">create virtual table virt_table using my_module(arguments following) as (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  id integer not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name text</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">);</span></div></div></div></div></div><p>becomes</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE VIRTUAL TABLE virt_table USING my_module(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  id INTEGER NOT NULL,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name TEXT</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">);</span></div></div></div></div></div><p>The normalized text (keywords capitalized, whitespace normalized) of the table declaration in the <code>as</code> clause is used as the arguments.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="other-details"></a>Other details<a aria-hidden="true" tabindex="-1" class="hash-link" href="#other-details" title="Direct link to heading">#</a></h3><p>Virtual tables go into their own section in the JSON and they include the <code>module</code> and <code>moduleArgs</code> entries, they are additionally
marked <code>isVirtual</code> in case you want to use the same processing code for virtual tables as normal tables.  The JSON format is otherwise
the same, although some things can&#x27;t happen in virtual tables (e.g. there is no <code>TEMP</code> option so <code>&quot;isTemp&quot;</code> must be false in the JSON.</p><p>For purposes of schema processing, virtual tables are on the <code>@recreate</code> plan, just like indices, triggers, etc.  This is the only option since
the <code>alter table</code> form is not allowed on a virtual table.</p><p>Semantic validation enforces &quot;no alter statements on virtual tables&quot; as well as other things like, no indices, and no triggers, since SQLite
does not support any of those things.</p><p>Finally, because virtual tables are on the <code>@recreate</code> plan, you may not have foreign keys that reference virtual tables. Such keys seem
like a bad idea in any case.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/facebook">facebook</a><a class="margin-horiz--sm" href="/blog/tags/cg-sql">cg-sql</a></div></footer></article><div><a href="https://github.com/facebookincubator/CG-SQL/edit/master/website/blog/blog/2020-12-16-virtual-table-intro.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/named-types-into"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« Introducing Named Types</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/arg-bungle-intro"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Introducing  Argument Bundles Â»</div></a></div></nav></div></div><div class="col col--2"><div class="tableOfContents_3SO_"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#case-1-example" class="table-of-contents__link">Case 1 Example</a></li><li><a href="#case-2-example" class="table-of-contents__link">Case 2 Example</a></li><li><a href="#case-3-example" class="table-of-contents__link">Case 3 Example</a></li><li><a href="#other-details" class="table-of-contents__link">Other details</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Learn</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/introduction">Getting Started</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://www.youtube.com/channel/UC2lTapw2Um90sZpGQVaynEg" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube</a></li><li class="footer__item"><a href="https://twitter.com/fbOpenSource" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Legal</h4><ul class="footer__items"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy</a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms</a></li></ul></div></div><div class="text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" target="_blank" rel="noopener noreferrer" class="footerLogoLink_1zJy"><img class="footer__logo" alt="Meta Platforms Open Source Logo" src="/img/oss_logo.png"></a></div><div>Copyright Â© 2022 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.cf675315.js"></script>
<script src="/runtime~main.638623f9.js"></script>
<script src="/main.6b85c48e.js"></script>
<script src="/1.faa8ac5d.js"></script>
<script src="/2.f1f5104c.js"></script>
<script src="/3.7dcf5e64.js"></script>
<script src="/ccc49370.284a7f8d.js"></script>
<script src="/ffbd8a12.0bf7db55.js"></script>
</body>
</html>