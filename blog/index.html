<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.65">
<title data-react-helmet="true">Blog | CG/SQL</title><meta data-react-helmet="true" property="og:title" content="Blog | CG/SQL"><meta data-react-helmet="true" name="description" content="Blog"><meta data-react-helmet="true" property="og:description" content="Blog"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/styles.4959ceee.css">
<link rel="preload" href="/styles.5dc5ab0d.js" as="script">
<link rel="preload" href="/runtime~main.92784f52.js" as="script">
<link rel="preload" href="/main.2de251bc.js" as="script">
<link rel="preload" href="/1.cd5cf55e.js" as="script">
<link rel="preload" href="/2.004730db.js" as="script">
<link rel="preload" href="/3.8420923d.js" as="script">
<link rel="preload" href="/a6aa9e1f.a6fb0fdf.js" as="script">
<link rel="preload" href="/df35883d.aec60cbf.js" as="script">
<link rel="preload" href="/e5f2a9ab.f662f705.js" as="script">
<link rel="preload" href="/6461331c.0d156b72.js" as="script">
<link rel="preload" href="/6e2020ca.4ec0a705.js" as="script">
<link rel="preload" href="/5820813e.b8ceb1ec.js" as="script">
<link rel="preload" href="/ebfa2195.6dc8f9ea.js" as="script">
<link rel="preload" href="/3217ea0f.3532bf33.js" as="script">
<link rel="preload" href="/3e3a85bc.10b31455.js" as="script">
<link rel="preload" href="/80400c32.ffe8943a.js" as="script">
<link rel="preload" href="/fc3479db.4c3a6871.js" as="script">
<link rel="preload" href="/b2b675dd.7523d3bf.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><strong class="navbar__title">CG/SQL</strong></a><a class="navbar__item navbar__link" href="/docs/introduction">Docs</a><a class="navbar__item navbar__link" href="/cql-guide/ch01">CQL Guide</a><a class="navbar__item navbar__link" href="/cql-guide/int01">CQL Internals</a><a class="navbar__item navbar__link" href="/program-diagram">Railroad Diagram</a><a class="navbar__item navbar__link" href="/json-diagram">Railroad Diagram: JSON</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><strong class="navbar__title">CG/SQL</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/introduction">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/cql-guide/ch01">CQL Guide</a></li><li class="menu__list-item"><a class="menu__link" href="/cql-guide/int01">CQL Internals</a></li><li class="menu__list-item"><a class="menu__link" href="/program-diagram">Railroad Diagram</a></li><li class="menu__list-item"><a class="menu__link" href="/json-diagram">Railroad Diagram: JSON</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><main class="col col--8 col--offset-2"><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_1mse"><a href="/blog/shared-fragments-intro">Introducing Shared Fragments</a></h2><div class="margin-vert--md"><time datetime="2021-12-14T00:00:00.000Z" class="blogPostDate_3bQP">December 14, 2021  Â· 8 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener"><img src="https://avatars2.githubusercontent.com/u/69631?s=200&amp;v=4" alt="CG/SQL Team"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener">CG/SQL Team</a></h4><small class="avatar__subtitle">Maintainer of CG/SQL</small></div></div></header><section class="markdown"><p>Shared fragments are a real game-changer for CQL.</p><p>Remember, these are designed to let you write part of a query and then substitute in parameters.  So it&#x27;s like a parameterized view in normal SQL terms.  But actually it&#x27;s more powerful than that, fragments also provide features that are more like Java generics.  Let&#x27;s do some examples.</p><p>Suppose we have a procedure which looks something like this:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-SQL codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC get_stuff(to_include_ text, to_exclude_ text)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  WITH</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  to_exclude_recursive_query (tok, rest) AS (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &#x27;&#x27;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      to_exclude_ || &#x27;,&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    UNION ALL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      substr(rest, 1, instr(rest, &#x27;,&#x27;) - 1),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      substr(rest, instr(rest, &#x27;,&#x27;) + 1)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    FROM to_exclude_recursive_query</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE rest &lt;&gt; &#x27;&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  to_exclude (id) AS (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT CAST(tok AS LONG)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    FROM to_exclude_recursive_query</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE tok &lt;&gt; &#x27;&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  to_include_recursive_query (tok, rest) AS (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &#x27;&#x27;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      to_include_ || &#x27;,&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    UNION ALL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      substr(rest, 1, instr(rest, &#x27;,&#x27;) - 1),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      substr(rest, instr(rest, &#x27;,&#x27;) + 1)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    FROM to_include_recursive_query</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE rest &lt;&gt; &#x27;&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  to_include (id) AS (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT CAST(tok AS LONG)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    FROM to_include_recursive_query</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE tok &lt;&gt; &#x27;&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  SELECT * from stuff S</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  WHERE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    S.id in (select * from to_include) AND</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    S.id not in (select * from to_exclude);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span></div></div></div></div></div><p>With shared fragments you could write something like this:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-SQL codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">@attribute(cql:shared_fragment)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC split_commas(str text)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  WITH splitter(tok, rest) AS (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT &#x27;&#x27;, IFNULL(str || &#x27;,&#x27;, &#x27;&#x27;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    UNION ALL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      substr(rest, 1, instr(rest, &#x27;,&#x27;) - 1),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      substr(rest, instr(rest, &#x27;,&#x27;) + 1)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    FROM splitter</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE rest &lt;&gt; &#x27;&#x27;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  select tok from splitter where tok &lt;&gt; &#x27;&#x27;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">@attribute(cql:shared_fragment)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC ids_from_string(str text)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  WITH toks(tok) AS (CALL split_commas(str))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  SELECT CAST(tok AS LONG) AS id from toks;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span></div></div></div></div></div><p>We now have a shared fragment called <code>split_commas</code> which can be anywhere like maybe in a standard include file.  There are some immediate benefits:</p><ul><li>the fragment is compiled on its own before usage so any errors are reported in the fragment<ul><li>in contrast, with macros you get errors when you try to use the macro and they are all charged to the line the macro appears on so it&#x27;s hopeless figuring out what&#x27;s wrong</li></ul></li><li>the text of the shared fragment will be the same, so it can be re-used in all locations, this can be a big binary size savings<ul><li>in contrast, macros are pre-processed before CQL ever sees the text so it doesn&#x27;t &quot;know&quot; it&#x27;s the same code</li></ul></li><li>fragments compose cleanly as we&#x27;ll see; and they have typed arguments</li><li>fragments can be independently tested outside of the context in which they appear<ul><li>make a test context and explore the fragment, no worries about it breaking on edge cases later</li></ul></li></ul><p>The first fragment called <code>split_commas</code> does exactly what it sounds like, it takes a string argument and makes a list of the strings in it.</p><p>The second fragment uses the first to split a string and then it converts all the strings to long integers.</p><p>Now instead of the above we could write:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-SQL codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#include &lt;stringsplit.sql&gt; /* whereever you put the fragments */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC get_stuff(to_include_ text, to_exclude_ text)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  WITH</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    to_include(id) AS (CALL ids_from_string(to_include_)),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    to_exclude(id) AS (CALL ids_from_string(to_exclude_))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  SELECT * from stuff S</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  WHERE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    S.id in (select * from to_include) AND</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    S.id not in (select * from to_exclude);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span></div></div></div></div></div><p>And of course since <code>ids_from_string</code> is somewhere shared (<code>stringsplit.sql</code>) so these fragments can be used
all over your code and you&#x27;ll only pay for the text one time.  This gives you great flexibility, very much
like parameterized views. You can have any number of these fragments, they will share code, they compose like crazy
and there is no schema cost!</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="generics"></a>Generics<a aria-hidden="true" tabindex="-1" class="hash-link" href="#generics" title="Direct link to heading">#</a></h3><p>A series of useful fragments for generating data would go a long way but there are other applications
of fragments and you might want to operate on various data sources without hard coding them all.  This is
where the generic form of fragments comes in. Consider a case where you want to be able to filter <code>stuff</code>
by say name and age.  You could create this fragment:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-SQL codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">@attribute(cql:shared_fragment)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC filter_stuff(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  pattern_ text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  min_age_ integer not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  max_age_ integer not null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  WITH</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    source(*) LIKE stuff</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  SELECT * from source S</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  WHERE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    S.name LIKE pattern_ AND</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    S.age BETWEEN min_age_ and max_age_;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span></div></div></div></div></div><p>Now imagine that we had added the shared fragment annotation to <code>get_stuff</code> (just like the above).
We could then write the following:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-SQL codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC the_right_stuff(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  to_include_ text,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  to_exclude_ text,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  pattern_ text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  min_age_ integer not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  max_age_ integer not null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  WITH</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    get_stuff(*) AS (call get_stuff(to_include_, to_exclude_)),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    filter_stuff(*) AS (call filter_stuff(pattern_, min_age_, max_age_)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      using get_stuff as source)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  SELECT * from filter_stuff S</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ORDER BY name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  LIMIT 5;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span></div></div></div></div></div><p>Or with some sugar to forward arguments and assume the CTE name matches, more economically:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-SQL codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC the_right_stuff(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  to_include_ text,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  to_exclude_ text,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  pattern_ text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  min_age_ integer not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  max_age_ integer not null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  WITH</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    (call get_stuff(*)),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    (call filter_stuff(*) using get_stuff as source)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  SELECT * from filter_stuff S</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ORDER BY name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  LIMIT 5;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span></div></div></div></div></div><p>The arg syntax <code>(*)</code> simply indicates that the arg names in the caller should match to the same names in the callee.  In
general <code>call foo(*)</code> expands to <code>call foo(from arguments like foo arguments)</code>.  <code>*</code> is rather more economical than that.</p><p>In this example <code>filter_stuff</code> doesn&#x27;t know where its data will be coming from, you bind its table parameter <code>source</code>
to a compatible data source of your choice. For example, this would also be legal:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-SQL codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC almost_the_right_stuff(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  pattern_ text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  min_age_ integer not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  max_age_ integer not null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  WITH</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    (call filter_stuff(*) using stuff as source)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  SELECT * from filter_stuff S</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ORDER BY name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  LIMIT 5;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="conditionals"></a>Conditionals<a aria-hidden="true" tabindex="-1" class="hash-link" href="#conditionals" title="Direct link to heading">#</a></h3><p>It&#x27;s often desirable to have some options in the generated SQL without having to fork your entire query.  Shared
fragments address this as well with the conditional form.  In this form the top level of the fragment is an
<code>IF</code> statement and there are a number of alternatives.  Here are some simple modifications to the above that illustrate
some of the possibilities.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-SQL codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">@attribute(cql:shared_fragment)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC filter_stuff(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  pattern_ text,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  min_age_ integer not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  max_age_ integer not null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  IF pattern_ IS NOT NULL THEN</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    WITH</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        source(*) LIKE stuff</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT * from source S</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        S.name LIKE pattern_ AND</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        S.age BETWEEN min_age_ and max_age_;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ELSE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    WITH</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        source(*) LIKE stuff</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT * from source S</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        S.age BETWEEN min_age_ and max_age_;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  END IF;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span></div></div></div></div></div><p>In the above if the input pattern is NULL then it is not considered, it won&#x27;t be part of the generated SQL at all. Note that
<code>source</code> (same name) appears in both branches and therefore must be the same type as it will be fulfilled by one actual table
parameter.</p><p>Now the above could have been achieved with something like this:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-SQL codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">pattern_ IS NULL OR S.name LIKE pattern_</span></div></div></div></div></div><p>But that would have no useful selectivity.  But in general you might be able to avoid joins and so forth
with your constraints.  Consider something like this hypothetical:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-SQL codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">@attribute(cql:shared_fragment)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC filter_stuff(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  pattern_ text,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  min_age_ integer not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  max_age_ integer not null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  IF pattern_ IS NOT NULL THEN</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    WITH</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        source(*) LIKE stuff</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT DISTINCT S.* from source S</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    INNER JOIN keywords K</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        K.keyword LIKE pattern_ AND</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        S.age BETWEEN min_age_ and max_age_;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ELSE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    WITH</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        source(*) LIKE stuff</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT * from source S</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        S.age BETWEEN min_age_ and max_age_;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  END IF;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span></div></div></div></div></div><p>Here we save the DISTINCT and the JOIN if there is no pattern which might be important.  Of course
there are probably better ways to match keywords but this is just an illustration of what&#x27;s possible.</p><p>There are numerous ways this flexibility can be used, again a simple example, a real schema
transform would be more complex.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-SQL codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">@attribute(cql:shared_fragment)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC get_stuff(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  to_include_ text,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  to_exclude_ text,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  schema_v2 bool not null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  IF schema_v2 THEN</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    WITH</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        to_include(id) AS (CALL ids_from_string(to_include_)),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        to_exclude(id) AS (CALL ids_from_string(to_exclude_))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT * from stuff_2 S</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        S.id in (select * from to_include) AND</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        S.id not in (select * from to_exclude);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ELSE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    WITH</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        to_include(id) AS (CALL ids_from_string(to_include_)),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        to_exclude(id) AS (CALL ids_from_string(to_exclude_))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT * from stuff S</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        S.id in (select * from to_include) AND</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        S.id not in (select * from to_exclude);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   END IF;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="validation"></a>Validation<a aria-hidden="true" tabindex="-1" class="hash-link" href="#validation" title="Direct link to heading">#</a></h3><p>All of this requires a bunch of checking, at least this:</p><ul><li>the LIKE forms can only appear in a shared fragment</li><li>the CALL forms must refer to shared fragments</li><li>the CALL args must be compatible</li><li>the number and type of the provided tables in USING must be correct</li><li>the shared fragment must be a single select statement or an IF statement with an ELSE<ul><li>the statement lists of the IF/ELSE combo must all be single select statements</li><li>all the choices in the IF block must return the same shape (this is normal for procedures)</li></ul></li><li>the shared fragment can&#x27;t have any out arguments</li><li>the provided fragment arguments cannot themselves use the nested SELECT construct</li></ul><p>I think this is a total game changer for SQL authoring and should go a long way to making it easier to get your work done
on SQLite. A good base set of shared fragments as part any suite of procedures seems like a good idea.</p><p>There are more details in the section on shared fragments in <a href="https://cgsql.dev/cql-guide/ch14" target="_blank" rel="noopener noreferrer">Chapter 14</a> of The Guide.</p><p>These features are in the current build as of today (12/14/2021).</p><p>Happy Holidays and stay safe.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/facebook">facebook</a><a class="margin-horiz--sm" href="/blog/tags/cg-sql">cg-sql</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_1mse"><a href="/blog/result-variable">Introducing @RC builtin variable</a></h2><div class="margin-vert--md"><time datetime="2021-02-21T00:00:00.000Z" class="blogPostDate_3bQP">February 21, 2021  Â· 1 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener"><img src="https://avatars2.githubusercontent.com/u/69631?s=200&amp;v=4" alt="CG/SQL Team"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener">CG/SQL Team</a></h4><small class="avatar__subtitle">Maintainer of CG/SQL</small></div></div></header><section class="markdown"><p>We&#x27;ve long needed a way to see the most recent SQLite result code SQLite in the context
of say a <code>catch</code> block (most other times you can assume SQLITE_OK was the last
result code otherwise control flow would transfer elsewhere. Sometimes SQLITE_ROW
or SQLITE_DONE might be the current result code.</p><p>Soon we&#x27;ll provide a sample header that declares the most common error codes in an enum but
for now you could do something like this:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- pasted from the sqlite.c</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#define SQLITE_BUSY         5   /* The database file is locked */</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- this is a contrived example</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> get_first_foo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">out</span><span class="token plain"> can_retry </span><span class="token keyword" style="font-style:italic">bool</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- can_retry is set to 0 automatically, language semantics guarantee this</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"> try</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> foo </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> bar </span><span class="token keyword" style="font-style:italic">limit</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">end</span><span class="token plain"> try</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"> catch</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">set</span><span class="token plain"> can_retry :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token variable" style="color:rgb(191, 199, 213)">@rc</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> SQLITE_BUSY</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    throw</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- rethrow the original error</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">end</span><span class="token plain"> catch</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/facebook">facebook</a><a class="margin-horiz--sm" href="/blog/tags/cg-sql">cg-sql</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_1mse"><a href="/blog/select-if-nothing">Introducing Select .. If Nothing</a></h2><div class="margin-vert--md"><time datetime="2021-02-14T00:00:00.000Z" class="blogPostDate_3bQP">February 14, 2021  Â· 2 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener"><img src="https://avatars2.githubusercontent.com/u/69631?s=200&amp;v=4" alt="CG/SQL Team"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener">CG/SQL Team</a></h4><small class="avatar__subtitle">Maintainer of CG/SQL</small></div></div></header><section class="markdown"><p>The nested select statement is frequently misused, in particular if you get no rows back from the expression that&#x27;s an error.  So for instance:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">set</span><span class="token plain"> x_ :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> x </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> foo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">x </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> y</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>This will throw (with a peculiar error, <code>SQLITE_DONE</code>) if there is no such row.</p><p>Sometimes people try to fix this problem with a nullcheck:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">set</span><span class="token plain"> x_ :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> IFNULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> x </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> foo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">x </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> y</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>That doesn&#x27;t help at all.  It&#x27;s not a null value situation, there&#x27;s no row at all.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">set</span><span class="token plain"> x_ :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> IFNULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">x</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> foo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">x </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> y</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>Is likewise unhelpful.  To help with this situation we add two forms:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- useful if foo.x is already known to be not null</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">set</span><span class="token plain"> x_ :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> x </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> foo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">x </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> y </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"> NOTHING </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- useful if foo.x might be null</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">set</span><span class="token plain"> x_ :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> x </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> foo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">x </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> y </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"> NOTHING </span><span class="token operator" style="color:rgb(137, 221, 255)">OR</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>Both of these deal with the case where there is no row.  The second lets you have a simple default for both
no row or null value.  That form is equivalent to:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">set</span><span class="token plain"> x_ :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> IFNULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">x</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> foo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">x </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> y </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"> NOTHING </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>i.e. both problem cases are handled.</p><p>Of course the -1 here could be any valid expression, even a second <code>(select...)</code></p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/facebook">facebook</a><a class="margin-horiz--sm" href="/blog/tags/cg-sql">cg-sql</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_1mse"><a href="/blog/free-empty-results">Change in No-Result Semantics</a></h2><div class="margin-vert--md"><time datetime="2021-02-10T00:00:00.000Z" class="blogPostDate_3bQP">February 10, 2021  Â· 1 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener"><img src="https://avatars2.githubusercontent.com/u/69631?s=200&amp;v=4" alt="CG/SQL Team"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener">CG/SQL Team</a></h4><small class="avatar__subtitle">Maintainer of CG/SQL</small></div></div></header><section class="markdown"><p>Important change in CQL semantics.</p><p>Previously if you did an early return, or fall through the end, from a procedure that is supposed to return a result set
but did not in fact provide one, you would get a fake SQLITE_ERROR.  Now you get an empty result set for &quot;free&quot;.</p><p>This interpretation seems much more natural and avoids a lot of really annoying stub selects to comply with the contract.</p><p>This also works for the <code>out</code> statement in the same fashion.</p><p>If you want to return an error, use <code>throw</code>. This is a lot more natural...</p><p>examples:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- this gives you an empty result set if x &lt;= 0</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> maybe_return</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">x </span><span class="token keyword" style="font-style:italic">integer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> x </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> foo </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> foo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">y </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> x</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token keyword" style="font-style:italic">end</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- so does this</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> maybe_return</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">x </span><span class="token keyword" style="font-style:italic">integer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> x </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token keyword" style="font-style:italic">return</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">end</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> foo </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> foo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">y </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> x</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- so does this</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> maybe_out</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">x </span><span class="token keyword" style="font-style:italic">integer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> x </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> C </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> etc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">out</span><span class="token plain"> C</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">end</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/facebook">facebook</a><a class="margin-horiz--sm" href="/blog/tags/cg-sql">cg-sql</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_1mse"><a href="/blog/type-kinds-intro">Introducing Type &quot;Kinds&quot;</a></h2><div class="margin-vert--md"><time datetime="2021-01-20T00:00:00.000Z" class="blogPostDate_3bQP">January 20, 2021  Â· 3 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener"><img src="https://avatars2.githubusercontent.com/u/69631?s=200&amp;v=4" alt="CG/SQL Team"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener">CG/SQL Team</a></h4><small class="avatar__subtitle">Maintainer of CG/SQL</small></div></div></header><section class="markdown"><p>Further adding to the type calculus of the CQL language we introduced the ability to encode the &quot;kind&quot; of primitive types.  This
can be used in a number of ways -- like &quot;units&quot; for natural things and like a &quot;type&quot; for synthetic keys and other such.  It&#x27;s easier
to illustrate by example.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare job_id type long&lt;job_id&gt;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare person_id type long&lt;person_id&gt;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare j job_id;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">decalre p person_id;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">set p := j;  -- this is an error</span></div></div></div></div></div><p>With the above in place, other expressions like  <code>p == j</code> would also produce errors as these <code>long</code> values are no longer type compatible.  This is
a great way to add enforcement to your schema and procedures.  Likewise you can use these annotations to add &quot;units&quot; to your data types.  e.g.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare meters type real&lt;meters&gt;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare grams type real&lt;grams&gt;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare m meters;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare g grams;</span></div></div></div></div></div><p>Variables of type <code>grams</code> (e.g. <code>g</code>) are not compatible with variables of type <code>meters</code> (e.g. <code>m</code>) even though both are <code>real</code>.</p><p>Likewise, attemping to insert <code>grams</code> into a column that is typed to <code>meters</code> will give errors.  Of course SQLite doesn&#x27;t know about any of this
so all the <code>&lt;&gt;</code> stuff is removed in the generated SQL.  This is just about type enforcement at compile time.</p><p>Enumerations like:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare enum surface integer (paper, canvas);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare enum writer integer (pen, paper, brush);</span></div></div></div></div></div><p>enable this:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare s surface;                  -- s is now of type integer&lt;surface&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare w writer;                   -- w is now of type integer&lt;writer&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">set s := surface.paper;             -- ok</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">set s := writer.pen;                -- error</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">set w := writer.pencil;             -- ok</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">case when s == w then 1 else 0 end; -- error (w/s not comparable)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">set w := s;                         -- error again</span></div></div></div></div></div><p>additionally in DML/DDL:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">create table draw_action(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  w writer,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  s surface</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">insert into draw_action values(w, s); -- ok</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">insert into draw_action values(s, w); -- error!</span></div></div></div></div></div><p>So the type kinds can be quite helpful when dealing with loose variables.</p><p>The notion of specific types was added to the language nearly two years ago to support the <code>object</code> type because there was a great desire
to prevent <code>object&lt;dictionary&gt;</code> being assigned from <code>object&lt;list&gt;</code> but this &quot;type kind&quot;, whether it&#x27;s with units (e.g. &quot;meters&quot;, &quot;grams&quot;)
or a type name (e.g. &quot;job_id&quot;) adds a lot of high value type checking.</p><p>The kind can be added, stripped, or changed with a <code>cast</code> operation and the type system allows a constant or variable with no kind (e.g. &quot;1&quot;)
to mix and match with any kind so long as the base type is compatible as usual.  So you get the most value by using the specific type
consistently but you won&#x27;t go insane adding test cases that use constants for instance.</p><p>As of this writing the expression kinds are checked for compatibility everywhere plus or minus bugs.  There are extensive tests.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/facebook">facebook</a><a class="margin-horiz--sm" href="/blog/tags/cg-sql">cg-sql</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_1mse"><a href="/blog/named-types-into">Introducing Named Types</a></h2><div class="margin-vert--md"><time datetime="2021-01-14T00:00:00.000Z" class="blogPostDate_3bQP">January 14, 2021  Â· 2 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener"><img src="https://avatars2.githubusercontent.com/u/69631?s=200&amp;v=4" alt="CG/SQL Team"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener">CG/SQL Team</a></h4><small class="avatar__subtitle">Maintainer of CG/SQL</small></div></div></header><section class="markdown"><p>A common source of errors in stored procedures is incorrect typing in arguments.  For instance, a particular key
for an entity might need to be <code>LONG</code> or even always <code>LONG NOT NULL</code> or <code>LONG NOT NULL @SENSITIVE</code> and the only
way to do this in the past was maybe with some <code>#define</code> thing.  Otherwise you have to diligently get the type right
in all the places, and should it ever change, again you have to visit all the places.   To help with this situation,
and to make code a little more self-describing we add named types to the language.  This is a lot like <code>typedef</code> in
the C language.  They do not create different incompatible types but do let you name things well.</p><p>You can now write these sorts of forms:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare foo_id type long not null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">create table foo(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  id foo_id primary key autoincrement,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name text</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc inserter(name_ text, out id foo_id)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  insert into foo(id, name) values(NULL, name_);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  set id := last_insert_rowid();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div></div></div></div></div><p>Refer to the <a href="https://cgsql.dev/program-diagram#declare_stmt" target="_blank" rel="noopener noreferrer">railroad diagram</a> for the grammar details.</p><p>Additionally any enumerated type can be used as a type name.  e.g.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare enum thing integer (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  thing1,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  thing2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare x thing;</span></div></div></div></div></div><p>Enumerations always get &quot;not null&quot; in addition to their base type.</p><p>This isn&#x27;t a very complex feature but we hope that it will help create clearer code that is less likely to have type-related bugs.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/facebook">facebook</a><a class="margin-horiz--sm" href="/blog/tags/cg-sql">cg-sql</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_1mse"><a href="/blog/virtual-table-into">Introducing Virtual Tables</a></h2><div class="margin-vert--md"><time datetime="2020-12-16T00:00:00.000Z" class="blogPostDate_3bQP">December 16, 2020  Â· 5 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener"><img src="https://avatars2.githubusercontent.com/u/69631?s=200&amp;v=4" alt="CG/SQL Team"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener">CG/SQL Team</a></h4><small class="avatar__subtitle">Maintainer of CG/SQL</small></div></div></header><section class="markdown"><p>Language support for virtual tables has lagged since I always thought they were of little interest to
the language anyway. The <code>CREATE TABLE</code> forms in general are only declarations (except if you&#x27;re doing
the schema installer/upgrader output) and so you could just declare say a temp table that corresponds to the
virtual table that you made in the same way that you might declare say <code>sqlite_master</code> if you wanted to use it.
And since you have to register the module anyway, you may as well create the virtual table at the same time.</p><p>So there was no point in adding language support for the thing.</p><p>Furthermore the <code>CREATE VIRTUAL TABLE</code> form includes no information about the schema of the table so you&#x27;d
need some kind of declaration anyway in order to tell the language what the columns are for the table you
just created.  So again you may as well just declare it like a normal table and not include that table in your
schema upgrade file and be done with it.</p><p>And that was my thinking for the last 2 years. And then I learned something.</p><p>Virtual tables are durable.</p><p>Yeah, I always assumed that virtual tables were temp tables and they vanish and have to be redeclared every
session but that is not the case.  They are part of the durable schema so while you must pre-register the
module associated with the virtual table, the virtual table is like other tables in that you only create it
once and from then on it&#x27;s part of the schema every time the database loads until you <code>DROP</code> it.</p><p>This changes everything.</p><p>With virtual tables being durable they belong in the schema upgrade process.  And if they go there they also
have to go into the JSON output.  But we can&#x27;t use the vanilla syntax that SQLite uses because that syntax is:</p><ul><li>not parseable, because the module arguments can be literally anything (or nothing), even a letter to your grandma.</li><li>the arguments do not necessarily say anything about the table&#x27;s schema at all</li></ul><p>So in the CQL language I change the syntax a bit, the generalized form looks like this:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">create virtual table virt_table using my_module [(module arguments)]  as (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  id integer not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name text</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">);</span></div></div></div></div></div><p>The part after the <code>AS</code> is used by CQL as a table declaration for the virtual table.  The grammar for that
is exactly the same as a normal <code>CREATE TABLE</code> statement.  However that part is not transmitted to
SQLite; when the table is created, SQLite sees only the part it cares about, the part before the <code>AS</code>.</p><p>Now this leaves the module arguments, they can be one of three things:</p><ol><li>no arguments at all</li><li>a list of identifiers, constants, and parenthesized sublists just like in the <code>@attribute</code> form</li><li>the words <code>arguments following</code></li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="case-1-example"></a>Case 1 Example<a aria-hidden="true" tabindex="-1" class="hash-link" href="#case-1-example" title="Direct link to heading">#</a></h3><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">create virtual table virt_table using my_module as (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  id integer not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name text</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">);</span></div></div></div></div></div><p>becomes (to SQLite)</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE TABLE virt_table USING my_module;</span></div></div></div></div></div><p>Note: empty arguments <code>USING my_module()</code> are not allowed in the SQLite docs but do seem to work in SQLite.
We take the position that no args should be done with no parens, at least for now.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="case-2-example"></a>Case 2 Example<a aria-hidden="true" tabindex="-1" class="hash-link" href="#case-2-example" title="Direct link to heading">#</a></h3><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">create virtual table virt_table using my_module(foo, &#x27;goo&#x27;, (1.5, (bar, baz))) as (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  id integer not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name text</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">);</span></div></div></div></div></div><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE VIRTUAL TABLE virt_table USING my_module(foo, &quot;goo&quot;, (1.5, (bar, baz)));</span></div></div></div></div></div><p>This form allows for very flexible arguments but not totally arbitrary arguments, so it can still be
parsed and validated.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="case-3-example"></a>Case 3 Example<a aria-hidden="true" tabindex="-1" class="hash-link" href="#case-3-example" title="Direct link to heading">#</a></h3><p>This case recognizes the popular choice that the arguments are often the actual schema declaration
for the table in question. So</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">create virtual table virt_table using my_module(arguments following) as (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  id integer not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name text</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">);</span></div></div></div></div></div><p>becomes</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE VIRTUAL TABLE virt_table USING my_module(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  id INTEGER NOT NULL,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name TEXT</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">);</span></div></div></div></div></div><p>The normalized text (keywords capitalized, whitespace normalized) of the table declaration in the <code>as</code> clause is used as the arguments.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="other-details"></a>Other details<a aria-hidden="true" tabindex="-1" class="hash-link" href="#other-details" title="Direct link to heading">#</a></h3><p>Virtual tables go into their own section in the JSON and they include the <code>module</code> and <code>moduleArgs</code> entries, they are additionally
marked <code>isVirtual</code> in case you want to use the same processing code for virtual tables as normal tables.  The JSON format is otherwise
the same, although some things can&#x27;t happen in virtual tables (e.g. there is no <code>TEMP</code> option so <code>&quot;isTemp&quot;</code> must be false in the JSON.</p><p>For purposes of schema processing, virtual tables are on the <code>@recreate</code> plan, just like indices, triggers, etc.  This is the only option since
the <code>alter table</code> form is not allowed on a virtual table.</p><p>Semantic validation enforces &quot;no alter statements on virtual tables&quot; as well as other things like, no indices, and no triggers, since SQLite
does not support any of those things.</p><p>Finally, because virtual tables are on the <code>@recreate</code> plan, you may not have foreign keys that reference virtual tables. Such keys seem
like a bad idea in any case.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/facebook">facebook</a><a class="margin-horiz--sm" href="/blog/tags/cg-sql">cg-sql</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_1mse"><a href="/blog/arg-bungle-intro">Introducing  Argument Bundles</a></h2><div class="margin-vert--md"><time datetime="2020-12-08T00:00:00.000Z" class="blogPostDate_3bQP">December 8, 2020  Â· 6 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener"><img src="https://avatars2.githubusercontent.com/u/69631?s=200&amp;v=4" alt="CG/SQL Team"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener">CG/SQL Team</a></h4><small class="avatar__subtitle">Maintainer of CG/SQL</small></div></div></header><section class="markdown"><p>There are many cases where stored procedures require complex arguments using data shapes well known
to higher level languages or that come from the schema.  There is already some affordance for this
sort of thing in the form of this kind of pattern:</p><p>(I&#x27;ll continue to use this simple example as I discuss the generalization below)</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">create table Person (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   id text primary key,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   name text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   address text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   birthday real</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">);</span></div></div></div></div></div><p>Then maybe something like this</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc insert_person(like Person)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    insert into Person from arguments;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div></div></div></div></div><p>The above expands into:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc insert_person(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    id_ text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    name_ text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    address_ text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    birthday_ real)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    insert into Person(id, name, address, birthday)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        values(id_, name_, address_, birthday_);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div></div></div></div></div><p>And I think we can all agree the sugared version is a lot easier to reason about
and much less prone to errors as well.</p><p>Those features have been in the language for a long time and that&#x27;s all fine and well
but it isn&#x27;t general enough to handle the usual mix of situations.  For instance what
if you need a procedure that works with two people?  A hypothetical <code>insert_two_people</code>
procedure cannot be written with the old form.  This is where argument bundles come in.
The idea here is to name the bundle which provides useful reference.  To wit:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc insert_two_people(p1 like Person, p2 like Person)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    call insert_person(from p1);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    call insert_person(from p2);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div></div></div></div></div><p>or alternatively</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc insert_two_people(p1 like Person, p2 like Person)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    insert into Person from p1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    insert into Person from p2;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div></div></div></div></div><p>So what&#x27;s going on here?  Well, there are lots of reasons to keep the API to procedures simple
and adding general purpose structured types would be at odds with that.  It would require lots
of knowledge about C structure layout and whatnot.  And trying to call from java would require
very complex JNI for any such procedure.  So we avoid all that.  We keep simple arguments.
The above expands into:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc insert_person(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    p1_id text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    p1_name text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    p1_address text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    p1_birthday real,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    p2_id text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    p2_name text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    p2_address text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    p2_birthday real)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    insert into Person(id, name, address, birthday)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        values(p1_id, p1_name, p1_address, p1_birthday);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    insert into Person(id, name, address, birthday)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        values(p2_id, p2_name, p2_address, p2_birthday);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div></div></div></div></div><p>Or course the types don&#x27;t have to be the same, you can create and name shapes of your choice.  The language allow
you to use an argument bundle in all the places that a cursor was previously a valid source.  That includes <code>insert</code>,
<code>fetch</code>, <code>update cursor</code>, and procedure calls.  You can refer to the arguments by their expanded name <code>p1_address</code>
or alternatively <code>p1.address</code> means the same thing.</p><p>Here&#x27;s another example showing a silly but illustrative thing you could do:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc insert_lotsa_people(P like Person)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    declare C cursor like P;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fetch C from P;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    declare i integer not null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    set i := 0;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    while (i &lt; 20)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        update cursor C using</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            printf(&quot;id_%d&quot;, i) id;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        insert into Person from C;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    end;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div></div></div></div></div><p>The above shows that you can use a bundle as the source of a shape elsewhere, and you can
use a bundle as a source of data to load a cursor.  After which you can do all the usual value cursor things
like <code>out</code> statements and so forth.</p><p>In order to call procedures with argument bundles more readily from other languages, the JSON output now includes additional
information about where procedure arguments originated; The field with this information is creatively called &quot;argOrigin:&quot;
and it has 3 forms.</p><ul><li>&quot;arg_name&quot; -&gt; the argument is not an expansion of anything</li><li>&quot;T arg_name&quot; -&gt; the argument came from <code>like T</code><ul><li>there will be one arg for each member of T</li><li>the formal argument name for this arg will be arg<em>name</em></li><li>if T is procedure arguments <code>like p1 arguments</code> then you&#x27;ll get  &quot;p1[arguments] arg_name&quot;</li></ul></li><li>&quot;name T arg_name&quot; -&gt; the argument came from <code>name like T</code> (a named bundle)<ul><li>there will be one arg for each member of T</li><li>the formal argument name for this arg will be T_arg_name</li><li>T could be procedure arguments as above</li></ul></li><li>If the source of an argument was a cursor or argument bundle name you get instead that thing&#x27;s shape source name<ul><li>this is always better because cursor names and bundle names are not globally unique.</li></ul></li><li>If the cursor had an anonymous source (e.g. <code>like select 1 x</code>) then you get the useless shape name &quot;select&quot;<ul><li>this is an indicator that you should make some ad hoc struct for this procedure because there is no useful name for the arg bundle&#x27;s type</li></ul></li></ul><p>None of this matters unless you&#x27;re trying to make wrappers for a CQL procedure for some other language
and you&#x27;d like to have your wrapper deal with structs rather than all loose arguments.  the JSON
basically tells you the structs.</p><p>Interestingly, argument bundles resulted in a significant reduction of code in the compiler.  The argument bundle
name has to be usable in the contexts where a cursor was previously usable.  It is another source of shaped data.
Getting that to work  proved to be super simple as the two forms look almost identical to the compiler -- no coincidence there.
So very little code was required to make <code>from [cursor_name]</code> work with <code>from [any_shape_name]</code> in the half dozen or so places
that this construct is allowed (e.g. procedure call arguments, insert statements, etc.).  However, there was as
much code associated with <code>from arguments</code> as there was <code>from cursor_name</code>.  And the code was nearly identical..</p><p>When argument bundles were introduced the natural thing to do was to create an artifical bundle called &quot;arguments&quot; which
represents the bundle that is ALL the arguments.  With that done, all the code for <code>from arguments</code> could be deleted
because <code>arguments</code> itself was a valid shape name.  Hence <code>insert into T from arguments</code> &quot;just works&quot;.  And so half
the rewrites were deleted.  The only cost was that the form <code>from arguments like shape</code> became the cursor form
<code>from arguments(like shape)</code> which only adds mandatory parens to a form that was largely unused anyway (there were two
cases in our entire codebase).  The cursor form is more general as you can do <code>from C(like A, like B)</code> to get the
fields that match <code>A</code> then those that match <code>B</code>.  Arguments get this for free as well (well, at the cost of parens).</p><p>So overall, this feature was added, and the compiler got smaller and cleaner.  Only the test suite had to grow.</p><p>Stay safe out there.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/facebook">facebook</a><a class="margin-horiz--sm" href="/blog/tags/cg-sql">cg-sql</a><a class="margin-horiz--sm" href="/blog/tags/errors">errors</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_1mse"><a href="/blog/declare-enum-intro">Introducing Declare Enum</a></h2><div class="margin-vert--md"><time datetime="2020-12-03T00:00:00.000Z" class="blogPostDate_3bQP">December 3, 2020  Â· 5 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener"><img src="https://avatars2.githubusercontent.com/u/69631?s=200&amp;v=4" alt="CG/SQL Team"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener">CG/SQL Team</a></h4><small class="avatar__subtitle">Maintainer of CG/SQL</small></div></div></header><section class="markdown"><p>There is an unfortunate pattern of hard coding constants in SQL which I think comes from the
fact that there&#x27;s not an especially good way to encode constants in SQL.  Things are a little
better In CG/SQL&#x27;s CQL language because it&#x27;s normal to run things through the pre-processor first
so you can do things like:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define BUSINESS_TYPE_RESTAURANT 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define BUSINESS_TYPE_LAUNDROMAT 2</span></div></div></div></div></div><p>Having done so, you could write:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">insert into Business using</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   &quot;Rico&#x27;s Laundry&quot;  name,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   BUSINESS_TYPE_LAUNDROMAT type;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- by the time SQL sees this it becomes</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">insert into Business(name, type) values(&#x27;Rico&#x27;&#x27;s Laundry&#x27;, 2);</span></div></div></div></div></div><p>And at least you don&#x27;t have to see these loose &#x27;2&#x27; values all over. An especially unfortunate
form is the below, in which the auther is clearly crying for a symbol to use:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">insert into Business using</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   &quot;Rico&#x27;s Laundry&quot;  name,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   2 type; /* laundromat */</span></div></div></div></div></div><p>But if we use <code>#define</code> the language knows nothing of the names and it can&#x27;t help you manage them
or export them consistently or anything like that.  I guess <code>#define</code> is pretty useful in several
langauges (C and C++) so you could maybe <code>#include</code> the macros somehow but that doesn&#x27;t seem
especially great.  And if you need them in Java you&#x27;re getting no help at all.</p><p>So to this world we add enumerated constants.  This is a bit short of enumerated types as we&#x27;ll
see later.  You can now write something like this:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare enum business_type integer (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  restuarant,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  laundromat,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  corner_store = 11+3  /* math added for demo purposes only */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">);</span></div></div></div></div></div><p>After this:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">select business_type.corner_store;</span></div></div></div></div></div><p>is the same as</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">select 14;</span></div></div></div></div></div><p>And that is exactly what SQLite will see, the literal 14.</p><p>What&#x27;s going on here?  There&#x27;s just a few rules:</p><ul><li>the enumeration can be any numeric type (bool, integer, long integer, real)</li><li>the values of the enumeration start at 1 (i.e. if there is no <code>= expression</code> the first item will be 1, not 0)</li><li>if you don&#x27;t specify a value, the next value is the previous value + 1</li><li>if you do specify a value it can be any constant expression and it will be cast to the type of the enumeration (even if thatis lossy)</li><li>the enumeration can refer to previous values in itself with no qualification <code>(big = 100.0, medium = big/2, small = medium/2)</code></li><li>the enumeration can refer to previously defined enumerations as usual <code>(code = business_type.restaurant)</code></li><li>Once the enumeration is defined you refer to its members in a fully qualified fashion <code>enum_name.member_name</code> elsewhere</li></ul><p>Why is this better than macros?  Well for one thing the enum values can be checked at their declaration site, so if you
have errors you will hear about them in a more reasonable place.  But additionally since the structure is known to the
compiler it can give you useful information in the outputs.</p><p>In the <code>.h</code> files you get:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">enum business_type {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  business_type__restaurant = 1,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  business_type__laundromat = 2,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  business_type__corner_store = 14</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">};</span></div></div></div></div></div><p>In case of floating point values such as:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare enum floating real (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  one = 1.0,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  two = 2.0,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  e = 2.71828,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  pi = 3.14159</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">);</span></div></div></div></div></div><p>You get:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// enum floating (floating point values)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define floating__one 1.000000e+00</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define floating__two 2.000000e+00</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define floating__e 2.718280e+00</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define floating__pi 3.141590e+00</span></div></div></div></div></div><p>Which is unfortunately the best you can do since C has no floating point enums.</p><p>But in both cases the <code>enums</code> section of the JSON has the name of the enums and their members and values ready to go.
With these values you can readily generate (with moustache or something) the language interfaces of your choice.  This
is a real help if you&#x27;re trying to make helpers to call your CQL from say Java or something.</p><p>To do all this we needed to add some constant folding and general evaluation to the compiler.  It&#x27;s not much,
just the normal numeric types and null.  The supported operations include:</p><p><code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>, <code>%</code>, <code>|</code>, <code>&amp;</code>, <code>&lt;&lt;</code>, <code>&gt;&gt;</code>, <code>~</code>, <code>and</code>, <code>or</code>, <code>not</code>, <code>==</code>, <code>&lt;=</code>, <code>&gt;=</code>, <code>!=</code>, <code>&lt;</code>, <code>&gt;</code>, the <code>cast</code> operator
and the <code>case</code> forms.  These are enough to make a lot of very interesting expressions, all of which are envaluated at
compile time.</p><p>While the constant folding was added to allow for rich <code>enum</code> expressions, there is also the <code>const()</code> primitive in the
language now which can appear anywhere a literal could appear.  This allows you do things that were previously not
allowed such as:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">create table something(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  x integer default const((1&lt;&lt;16)|0xf) /*  again the math is just for illustration */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">);</span></div></div></div></div></div><p>The <code>const</code> form is also very useful in macros:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define SOMETHING const(12+3)</span></div></div></div></div></div><p>This form ensures that the constant will be evaluated at compile time. Const can also also nest so you can build these
kinds of macros from other macros or you can build enums this way. Anywhere you might need literals, you can use <code>const</code>.</p><p>Importantly, no enumerated data types were added to the language to do any of this.  The values can help you to
achieve some correctness by avoiding transcription mistakes but there is no additional type-safety provided here.
Indeed given the rich mix between these types in SQLite, and with SQLite having no knowledge of enumerations at
all it would be tricky to do a complete job.  Still, this might happen in the future.</p><p>But for now, declaring constants that are really an intimate part of your schema is now possible and the addition
of the constants to the <code>.h</code> files and the <code>.json</code> output should hopefully make these generally useful.  At least
we might see less of the hard-coded constant business with good values baked right into the schema declarations.</p><p>Happy Holidays.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/facebook">facebook</a><a class="margin-horiz--sm" href="/blog/tags/cg-sql">cg-sql</a><a class="margin-horiz--sm" href="/blog/tags/errors">errors</a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="margin-bottom--sm blogPostTitle_1mse"><a href="/blog/like-forms-tutorial">A quick tutorial on LIKE forms</a></h2><div class="margin-vert--md"><time datetime="2020-11-20T00:00:00.000Z" class="blogPostDate_3bQP">November 20, 2020  Â· 8 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener"><img src="https://avatars2.githubusercontent.com/u/69631?s=200&amp;v=4" alt="CG/SQL Team"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener">CG/SQL Team</a></h4><small class="avatar__subtitle">Maintainer of CG/SQL</small></div></div></header><section class="markdown"><p>Everyone knows the usual expression syntax <code>x LIKE y</code> to do a string match.  But the CQL compiler also uses
<code>LIKE</code> in a different way that&#x27;s powerful and important.  CQL has the notion of data shapes and you use
<code>LIKE</code> to refer to them.  The simplest source of a data shape, and maybe the most common, is a table.
Maybe something like this:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">table</span><span class="token plain"> T</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> id </span><span class="token keyword" style="font-style:italic">integer</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> name </span><span class="token keyword" style="font-style:italic">text</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> age </span><span class="token keyword" style="font-style:italic">integer</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>Now suppose you want to write a procedure that can insert a row into that table, You could write</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> insert_into_T</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  id_ </span><span class="token keyword" style="font-style:italic">integer</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name_ </span><span class="token keyword" style="font-style:italic">text</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  age_ </span><span class="token keyword" style="font-style:italic">integer</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">insert</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">into</span><span class="token plain"> T</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> age</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">  </span><span class="token keyword" style="font-style:italic">values</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">id_</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> name_</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> age_</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>This is all fine and well but what if T had 50 columns?  That gets old fast.  And how can you
be sure that you inserted the columns into T in the right order?  This second example also compiles
even though it&#x27;s clearly wrong:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">  insert into T(id, name, age) values(age_, name_, id_);</span></div></div></div></div></div><p>And of course you can imagine things get only more complicated with more columns in T.</p><p>We started adding the <code>LIKE</code> form to ease these issues and to ensure some consistency in the APIs while preventing
simple transpostion errors.  So you can instead write:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc insert_into_T(like T)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  insert into T from arguments;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div></div></div></div></div><p>so here the <code>like T</code> in the argument list simply means &quot;make arguments that are the same as the columns of table T&quot; -- well,
almost. It also adds an <code>_</code> to the end of each name so you end up exactly the same declaration as the long form above.
But you won&#x27;t miss any arguments, and they&#x27;ll be in the right order.</p><p>And notice that we used <code>from arguments</code> to indicate that we wanted the values to come from the arguments in order. Again
this saves you from a lot of typing and a lot of error checking.  You can&#x27;t get the arguments in the wrong order.</p><p>These are the most basic patterns. But there are quite a few more.</p><p>Let&#x27;s suppose you want to write a procedure that returns in row with the highest age in the above.  Maybe you write
something like this:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> highest_age</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> C </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> T</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> M </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> C</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">loop</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">fetch</span><span class="token plain"> C</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> M </span><span class="token operator" style="color:rgb(137, 221, 255)">or</span><span class="token plain"> M</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">age </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain"> C</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">age</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       </span><span class="token keyword" style="font-style:italic">fetch</span><span class="token plain"> M </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> C</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token keyword" style="font-style:italic">end</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">out</span><span class="token plain"> M</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>Here we made a cursor <code>M</code> that is the same as the cursor <code>C</code> and then we are going to generate a single row result
from the cursor.  Note that if you use a cursor name like <code>M</code> in an expression it refers to the hidden boolean
that says if the cursor has a row in it or not.  So <code>M</code> begins empty and we will load it if it&#x27;s empty or if the age
is higher than what we&#x27;ve already got.</p><p>Let&#x27;s show a few more of the forms.  Suppose we don&#x27;t want to return <code>name</code>, just the <code>id</code> and the <code>age</code>.  We can
change things up a tiny bit.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> highest_age</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> C </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> T</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> M </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"> id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">99</span><span class="token plain"> age</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">loop</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">fetch</span><span class="token plain"> C</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> M </span><span class="token operator" style="color:rgb(137, 221, 255)">or</span><span class="token plain"> M</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">age </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain"> C</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">age</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">       </span><span class="token keyword" style="font-style:italic">fetch</span><span class="token plain"> M </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> C</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> M</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token keyword" style="font-style:italic">end</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">out</span><span class="token plain"> M</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>So two things to notice.  We used an <em>ad hoc</em> shape, making a fake <code>select</code> statement that returns the shape we want.  This
select doesn&#x27;t run but it does define types and columns easily.  Two not null integers in this case.  Now <code>M</code> is not the
same as <code>C</code> so we can&#x27;t use the simplest form <code>fetch M from C</code> we have to use the more general form. </p><p>Fully expanded, what we wrote becomes:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">FETCH</span><span class="token plain"> M</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> age</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">FROM</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">VALUES</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">C</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> C</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">age</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>But as you can see, we didn&#x27;t have to type all those column names.  And that&#x27;s kind of the point of the <code>LIKE</code> construct.</p><p>So we&#x27;ve covered a bunch of the shape sources already:</p><ul><li>a table name</li><li>a cursor name</li><li>a select statement that gives the shape in an ad hoc fashion</li></ul><p>There are three more</p><ul><li>a view name </li><li>the return shape of a procedure that returns a result set</li><li>the arguments of a procedure</li></ul><p>View names are pretty simple, and they work the same as table names so we don&#x27;t need to discuss those. Let&#x27;s look
at some of the other uses with procedures.</p><p>Suppose we have a procedure that can return a result set shape but we want to be able to mock its results so we
can fake whatever result we need for testing.  </p><p>We&#x27;ll complicate this a bit adding a new table (keeping short table names for the sample to save typing)</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">table</span><span class="token plain"> U</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> id </span><span class="token keyword" style="font-style:italic">integer</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> email </span><span class="token keyword" style="font-style:italic">text</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>And here&#x27;s a procedure:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> my_proc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> T</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> U</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">email </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> T </span><span class="token keyword" style="font-style:italic">inner</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">join</span><span class="token plain"> U </span><span class="token keyword" style="font-style:italic">on</span><span class="token plain"> T</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">id </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> U</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">id</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>Now we want to be able to make any fake result we want, so maybe want a temp table. No problem:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> _init_fake_results</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">temp</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">table</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">exists</span><span class="token plain"> fake_results</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> my_proc</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> add_fake_result</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> fake_results</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">insert</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">into</span><span class="token plain"> fake_results </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> arguments</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> get_fake_results</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> fake_results</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>The above is very generic and will maintain well.  You can see we made a temp table that will have
exactly the same shape as whatever <code>my_proc</code> returns.  In this case it becomes:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">PROC</span><span class="token plain"> _init_fake_results </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">BEGIN</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">TEMP</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">TABLE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">NOT</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">EXISTS</span><span class="token plain"> fake_results</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    id </span><span class="token keyword" style="font-style:italic">INTEGER</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    name </span><span class="token keyword" style="font-style:italic">TEXT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    age </span><span class="token keyword" style="font-style:italic">INTEGER</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    email </span><span class="token keyword" style="font-style:italic">TEXT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">END</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>And the rest are patterns we&#x27;ve seem before.</p><p>The last source of shapes are procedure arguments.  There&#x27;s lots of good cases for those, I wrote an <a href="https://cgsql.dev/blog/update" target="_blank" rel="noopener noreferrer">entry</a> on those previously but I&#x27;ll give a simple example here too.</p><p>Suppose we have this weird procedure:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> delete_stuff</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">age_ </span><span class="token keyword" style="font-style:italic">integer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> name_ </span><span class="token keyword" style="font-style:italic">text</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> age_ </span><span class="token operator" style="color:rgb(137, 221, 255)">is</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token keyword" style="font-style:italic">delete</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> T </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> T</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">age </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> age_</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">end</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> name_ </span><span class="token operator" style="color:rgb(137, 221, 255)">is</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token keyword" style="font-style:italic">delete</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> T </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> T</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">name </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> name_</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">end</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>What if we wanted to log any errors that happen here?  Maybe make a verison that logs.  We can do it like this:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> delete_and_log</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> delete_stuff arguments</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"> try</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">call</span><span class="token plain"> delete_stuff</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> arguments</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">end</span><span class="token plain"> try</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"> catch</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">call</span><span class="token plain"> printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;delete failed\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- or whatever</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    throw</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">end</span><span class="token plain"> catch</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>The nice thing about this logging wrapper procedure is that if <code>delete_stuff</code> changes, the wrapper will change with it.</p><p>That covers all of the shape sources and as we saw we can use them to create things like cursors, tables, and argument lists.
We can use them to specify a subset of columns that might be of interest when fetching or updating cursors.  And we can use
them in one last way -- to restrict arguments to a particular shape.  Let&#x27;s see how that works by making the previous logger
a little different.  Here we added an argument which tells if we should look.  And that might look like it would
spoil the <code>from arguments</code> part of the forwarding, but there is the final way to use <code>LIKE</code>.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> delete_and_log2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">log </span><span class="token keyword" style="font-style:italic">bool</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> delete_stuff arguments</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> log </span><span class="token operator" style="color:rgb(137, 221, 255)">and</span><span class="token plain"> age_ </span><span class="token operator" style="color:rgb(137, 221, 255)">is</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">call</span><span class="token plain"> printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;deleting %d\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> age_</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- or whatever</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">end</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> log </span><span class="token operator" style="color:rgb(137, 221, 255)">and</span><span class="token plain"> name_ </span><span class="token operator" style="color:rgb(137, 221, 255)">is</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">call</span><span class="token plain"> printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;deleting %d\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> name_</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- or whatever</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">end</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">call</span><span class="token plain"> delete_stuff</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> arguments </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> delete_stuff arguments</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>So this form lets you use some of your arguments, the ones that match a certain shape.  And as we saw in
the previous article you can also use <code>from C</code> to pass arguments where <code>C</code> is a cursor and in that case
you can also specify that arguments be matched by name <code>from C like shape</code>.  In both those cases the
formal parameter names of the called procedure are matched against the names of the shape and passed in
the order of the formals.  So this is like &quot;call by name&quot;, the fields of the cursor or the order of
arguments in the argument list might be different than the formals but you&#x27;ll get the correct items
in the correct order regardless, because it matches by name.</p><p>These forms can save you a lot of typing... and are excellent at avoiding errors and improving maintainability.
Where they appear in SQL statements, everything is expanded before it goes to SQLite so SQLite will see
normal syntax forms.  Which is good because obviously SQLite doesn&#x27;t know anything about this enhanced
<code>LIKE</code> business.</p><p>In the examples above there were only one or two columns with very short names, but in real world code
there can easily be dozens of columns with very long names.  In those cases, these forms really shine.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/facebook">facebook</a><a class="margin-horiz--sm" href="/blog/tags/cg-sql">cg-sql</a><a class="margin-horiz--sm" href="/blog/tags/errors">errors</a></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/page/2"><h4 class="pagination-nav__label">Older Entries Â»</h4></a></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Learn</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/introduction">Getting Started</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://www.youtube.com/channel/UC2lTapw2Um90sZpGQVaynEg" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube</a></li><li class="footer__item"><a href="https://twitter.com/fbOpenSource" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Legal</h4><ul class="footer__items"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy</a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms</a></li></ul></div></div><div class="text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" target="_blank" rel="noopener noreferrer" class="footerLogoLink_1zJy"><img class="footer__logo" alt="Meta Platforms Open Source Logo" src="/img/oss_logo.png"></a></div><div>Copyright Â© 2021 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.5dc5ab0d.js"></script>
<script src="/runtime~main.92784f52.js"></script>
<script src="/main.2de251bc.js"></script>
<script src="/1.cd5cf55e.js"></script>
<script src="/2.004730db.js"></script>
<script src="/3.8420923d.js"></script>
<script src="/a6aa9e1f.a6fb0fdf.js"></script>
<script src="/df35883d.aec60cbf.js"></script>
<script src="/e5f2a9ab.f662f705.js"></script>
<script src="/6461331c.0d156b72.js"></script>
<script src="/6e2020ca.4ec0a705.js"></script>
<script src="/5820813e.b8ceb1ec.js"></script>
<script src="/ebfa2195.6dc8f9ea.js"></script>
<script src="/3217ea0f.3532bf33.js"></script>
<script src="/3e3a85bc.10b31455.js"></script>
<script src="/80400c32.ffe8943a.js"></script>
<script src="/fc3479db.4c3a6871.js"></script>
<script src="/b2b675dd.7523d3bf.js"></script>
</body>
</html>