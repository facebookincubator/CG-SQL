<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.65">
<title data-react-helmet="true">Error Tracing Helper Macro | CG/SQL</title><meta data-react-helmet="true" property="og:title" content="Error Tracing Helper Macro | CG/SQL"><meta data-react-helmet="true" name="description" content="Following up on the last blog entry, I thought it would be useful to present a simple error tracing macro that you can use"><meta data-react-helmet="true" property="og:description" content="Following up on the last blog entry, I thought it would be useful to present a simple error tracing macro that you can use"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/styles.dc3f3d75.css">
<link rel="preload" href="/styles.37f2ffb6.js" as="script">
<link rel="preload" href="/runtime~main.97bf4034.js" as="script">
<link rel="preload" href="/main.e1cf7dc9.js" as="script">
<link rel="preload" href="/1.5f8f6e6f.js" as="script">
<link rel="preload" href="/2.6ec20781.js" as="script">
<link rel="preload" href="/3.3e05f457.js" as="script">
<link rel="preload" href="/ccc49370.a219b328.js" as="script">
<link rel="preload" href="/c5ec0339.49851958.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><strong class="navbar__title">CG/SQL</strong></a><a class="navbar__item navbar__link" href="/docs/introduction">Docs</a><a class="navbar__item navbar__link" href="/cql-guide/ch01">CQL Guide</a><a class="navbar__item navbar__link" href="/program-diagram">Railroad Diagram</a><a class="navbar__item navbar__link" href="/json-diagram">Railroad Diagram: JSON</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><strong class="navbar__title">CG/SQL</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/introduction">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/cql-guide/ch01">CQL Guide</a></li><li class="menu__list-item"><a class="menu__link" href="/program-diagram">Railroad Diagram</a></li><li class="menu__list-item"><a class="menu__link" href="/json-diagram">Railroad Diagram: JSON</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--8 col--offset-2"><article><header><h1 class="margin-bottom--sm blogPostTitle_1mse">Error Tracing Helper Macro</h1><div class="margin-vert--md"><time datetime="2020-11-18T00:00:00.000Z" class="blogPostDate_3bQP">November 18, 2020  Â· 3 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener"><img src="https://avatars2.githubusercontent.com/u/69631?s=200&amp;v=4" alt="CG/SQL Team"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener">CG/SQL Team</a></h4><small class="avatar__subtitle">Maintainer of CG/SQL</small></div></div></header><section class="markdown"><p>Following up on the last blog entry, I thought it would be useful to present a simple error tracing macro that you can use
to see what kind of error flow is going on when you&#x27;re having trouble understanding why a procedure is returning
an error code. The idea is we want to create a macro that we can use like this:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN_VERBOSE_STDERR_TRACING;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Some procedure(s) that you want to trace</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">END_VERBOSE_STDERR_TRACING;</span></div></div></div></div></div><p>We can do that with something like the below macros.  These particular ones cause the output to go to <code>stderr</code> via <code>fprintf</code> but if that isn&#x27;t what you need you can simply edit the macro. The macros looks like this:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- manually force tracing on by redefining the cql_error_trace macro</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define BEGIN_VERBOSE_STDERR_TRACING \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @echo c, &quot;#undef cql_error_trace\n&quot;; \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @echo c, &quot;#define cql_error_trace() fprintf(stderr, \&quot;CQL Trace at %s:%d in %s: %d %s\\n\&quot;, __FILE__, __LINE__, _PROC_, _rc_, sqlite3_errmsg(_db_))\n&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define END_VERBOSE_STDERR_TRACING \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @echo c, &quot;#undef cql_error_trace\n&quot;; \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    @echo c, &quot;#define cql_error_trace()\n&quot;</span></div></div></div></div></div><p>So basically it&#x27;s telling CQL to emit a <code>#define</code> into its output stream.  In this case:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define cql_error_trace() fprintf(stderr, &quot;CQL Trace at %s:%d in %s: %d %s\n&quot;, __FILE__, __LINE__, _PROC_, _rc_, sqlite3_errmsg(_db_))</span></div></div></div></div></div><p>You could change that to any function you like, you can have it dump the errors where you like, or you can make it some dummy function you add so that you can set a breakpoint on it.</p><p>Whatever you do, do not leave your code with this sort of tracing enabled -- it&#x27;s far too expensive in terms of code size.  But it&#x27;s perfect if you have this one procedure that is failing and it&#x27;s hard for you to see where.</p><p>Obviously if you&#x27;re making a custom trace thingy you don&#x27;t need the macro at all, you can just emit your own <code>#define</code> with <code>@echo</code> as needed.</p><p>Note: <code>@echo</code> is quite a sledgehammer so don&#x27;t use it lightly and not in production code but it is quite helpful for this sort of thing.  CQL tests often use it to help make things visible to the tests.  If you use <code>@echo</code> in weird ways you might not get working code when the codegen changes in the future.</p><p>The relevant state that is available to you inside a macro like this is:</p><ul><li><code>__FILE__</code> the current filename (comes from the C pre-processor, this is the .c file name not the .sql)</li><li><code>__LINE__</code> the current line number (comes from the C pre-processor, this is the .c line number)</li><li><code>_rc_</code> the current SQLite result code (always the current return code in every CQL procedure that uses SQLite)</li><li><code>_db_</code> the current SQLite database pointer (always the current database in every CQL procedure that uses SQLite)</li><li><code>_PROC_</code> the current procedure name (CQL has a <code>#define</code> for this for you)</li></ul></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/facebook">facebook</a><a class="margin-horiz--sm" href="/blog/tags/cg-sql">cg-sql</a><a class="margin-horiz--sm" href="/blog/tags/errors">errors</a></div></footer></article><div><a href="https://github.com/facebookincubator/CG-SQL/edit/master/website/blog/blog/2020-11-18-error-tracing-macro.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/like-forms-tutorial"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« A quick tutorial on LIKE forms</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/error-tracing-intro"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Introducing General Purpose Error Tracing Â»</div></a></div></nav></div></div><div class="col col--2"><div class="tableOfContents_3SO_"></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Learn</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/introduction">Getting Started</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://www.youtube.com/channel/UC2lTapw2Um90sZpGQVaynEg" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube</a></li><li class="footer__item"><a href="https://twitter.com/fbOpenSource" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Legal</h4><ul class="footer__items"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy</a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms</a></li></ul></div></div><div class="text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" target="_blank" rel="noopener noreferrer" class="footerLogoLink_1zJy"><img class="footer__logo" alt="Facebook Open Source Logo" src="/img/oss_logo.png"></a></div><div>Copyright Â© 2021 Facebook, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.37f2ffb6.js"></script>
<script src="/runtime~main.97bf4034.js"></script>
<script src="/main.e1cf7dc9.js"></script>
<script src="/1.5f8f6e6f.js"></script>
<script src="/2.6ec20781.js"></script>
<script src="/3.3e05f457.js"></script>
<script src="/ccc49370.a219b328.js"></script>
<script src="/c5ec0339.49851958.js"></script>
</body>
</html>