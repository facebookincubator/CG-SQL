<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.65">
<title data-react-helmet="true">Introducing  Argument Bundles | CG/SQL</title><meta data-react-helmet="true" property="og:title" content="Introducing  Argument Bundles | CG/SQL"><meta data-react-helmet="true" name="description" content="There are many cases where stored procedures require complex arguments using data shapes well known"><meta data-react-helmet="true" property="og:description" content="There are many cases where stored procedures require complex arguments using data shapes well known"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/styles.b4d35cce.css">
<link rel="preload" href="/styles.480d1f30.js" as="script">
<link rel="preload" href="/runtime~main.a1bfb077.js" as="script">
<link rel="preload" href="/main.b815b31d.js" as="script">
<link rel="preload" href="/1.2e95473d.js" as="script">
<link rel="preload" href="/2.0c45b020.js" as="script">
<link rel="preload" href="/3.d04889a6.js" as="script">
<link rel="preload" href="/ccc49370.13cc85db.js" as="script">
<link rel="preload" href="/390ec20d.a4317ec1.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><strong class="navbar__title">CG/SQL</strong></a><a class="navbar__item navbar__link" href="/docs/introduction">Docs</a><a class="navbar__item navbar__link" href="/cql-guide/ch01">CQL Guide</a><a class="navbar__item navbar__link" href="/program-diagram">Railroad Diagram</a><a class="navbar__item navbar__link" href="/json-diagram">Railroad Diagram: JSON</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><strong class="navbar__title">CG/SQL</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/introduction">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/cql-guide/ch01">CQL Guide</a></li><li class="menu__list-item"><a class="menu__link" href="/program-diagram">Railroad Diagram</a></li><li class="menu__list-item"><a class="menu__link" href="/json-diagram">Railroad Diagram: JSON</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--8 col--offset-2"><article><header><h1 class="margin-bottom--sm blogPostTitle_1mse">Introducing  Argument Bundles</h1><div class="margin-vert--md"><time datetime="2020-12-08T00:00:00.000Z" class="blogPostDate_3bQP">December 8, 2020  Â· 6 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener"><img src="https://avatars2.githubusercontent.com/u/69631?s=200&amp;v=4" alt="CG/SQL Team"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener">CG/SQL Team</a></h4><small class="avatar__subtitle">Maintainer of CG/SQL</small></div></div></header><section class="markdown"><p>There are many cases where stored procedures require complex arguments using data shapes well known
to higher level languages or that come from the schema.  There is already some affordance for this
sort of thing in the form of this kind of pattern:</p><p>(I&#x27;ll continue to use this simple example as I discuss the generalization below)</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">create table Person (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   id text primary key,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   name text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   address text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   birthday real</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">);</span></div></div></div></div></div><p>Then maybe something like this</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc insert_person(like Person)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    insert into Person from arguments;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div></div></div></div></div><p>The above expands into:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc insert_person(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    id_ text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    name_ text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    address_ text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    birthday_ real)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    insert into Person(id, name, address, birthday)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        values(id_, name_, address_, birthday_);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div></div></div></div></div><p>And I think we can all agree the sugared version is a lot easier to reason about
and much less prone to errors as well.</p><p>Those features have been in the language for a long time and that&#x27;s all fine and well
but it isn&#x27;t general enough to handle the usual mix of situations.  For instance what
if you need a procedure that works with two people?  A hypothetical <code>insert_two_people</code>
procedure cannot be written with the old form.  This is where argument bundles come in.
The idea here is to name the bundle which provides useful reference.  To wit:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc insert_two_people(p1 like Person, p2 like Person)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    call insert_person(from p1);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    call insert_person(from p2);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div></div></div></div></div><p>or alternatively</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc insert_two_people(p1 like Person, p2 like Person)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    insert into Person from p1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    insert into Person from p2;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div></div></div></div></div><p>So what&#x27;s going on here?  Well, there are lots of reasons to keep the API to procedures simple
and adding general purpose structured types would be at odds with that.  It would require lots
of knowledge about C structure layout and whatnot.  And trying to call from java would require
very complex JNI for any such procedure.  So we avoid all that.  We keep simple arguments.
The above expands into:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc insert_person(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    p1_id text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    p1_name text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    p1_address text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    p1_birthday real,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    p2_id text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    p2_name text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    p2_address text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    p2_birthday real)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    insert into Person(id, name, address, birthday)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        values(p1_id, p1_name, p1_address, p1_birthday);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    insert into Person(id, name, address, birthday)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        values(p2_id, p2_name, p2_address, p2_birthday);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div></div></div></div></div><p>Or course the types don&#x27;t have to be the same, you can create and name shapes of your choice.  The language allow
you to use an argument bundle in all the places that a cursor was previously a valid source.  That includes <code>insert</code>,
<code>fetch</code>, <code>update cursor</code>, and procedure calls.  You can refer to the arguments by their expanded name <code>p1_address</code>
or alternatively <code>p1.address</code> means the same thing.</p><p>Here&#x27;s another example showing a silly but illustrative thing you could do:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc insert_lotsa_people(P like Person)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    declare C cursor like P;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fetch C from P;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    declare i integer not null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    set i := 0;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    while (i &lt; 20)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        update cursor C using</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            printf(&quot;id_%d&quot;, i) id;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        insert into Person from C;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    end;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div></div></div></div></div><p>The above shows that you can use a bundle as the source of a shape elsewhere, and you can
use a bundle as a source of data to load a cursor.  After which you can do all the usual value cursor things
like <code>out</code> statements and so forth.</p><p>In order to call procedures with argument bundles more readily from other languages, the JSON output now includes additional
information about where procedure arguments originated; The field with this information is creatively called &quot;argOrigin:&quot;
and it has 3 forms.</p><ul><li>&quot;arg_name&quot; -&gt; the argument is not an expansion of anything</li><li>&quot;T arg_name&quot; -&gt; the argument came from <code>like T</code><ul><li>there will be one arg for each member of T</li><li>the formal argument name for this arg will be arg<em>name</em></li><li>if T is procedure arguments <code>like p1 arguments</code> then you&#x27;ll get  &quot;p1[arguments] arg_name&quot;</li></ul></li><li>&quot;name T arg_name&quot; -&gt; the argument came from <code>name like T</code> (a named bundle)<ul><li>there will be one arg for each member of T</li><li>the formal argument name for this arg will be T_arg_name</li><li>T could be procedure arguments as above</li></ul></li><li>If the source of an argument was a cursor or argument bundle name you get instead that thing&#x27;s shape source name<ul><li>this is always better because cursor names and bundle names are not globally unique.</li></ul></li><li>If the cursor had an anonymous source (e.g. <code>like select 1 x</code>) then you get the useless shape name &quot;select&quot;<ul><li>this is an indicator that you should make some ad hoc struct for this procedure because there is no useful name for the arg bundle&#x27;s type</li></ul></li></ul><p>None of this matters unless you&#x27;re trying to make wrappers for a CQL procedure for some other language
and you&#x27;d like to have your wrapper deal with structs rather than all loose arguments.  the JSON
basically tells you the structs.</p><p>Interestingly, argument bundles resulted in a significant reduction of code in the compiler.  The argument bundle
name has to be usable in the contexts where a cursor was previously usable.  It is another source of shaped data.
Getting that to work  proved to be super simple as the two forms look almost identical to the compiler -- no coincidence there.
So very little code was required to make <code>from [cursor_name]</code> work with <code>from [any_shape_name]</code> in the half dozen or so places
that this construct is allowed (e.g. procedure call arguments, insert statements, etc.).  However, there was as
much code associated with <code>from arguments</code> as there was <code>from cursor_name</code>.  And the code was nearly identical..</p><p>When argument bundles were introduced the natural thing to do was to create an artifical bundle called &quot;arguments&quot; which
represents the bundle that is ALL the arguments.  With that done, all the code for <code>from arguments</code> could be deleted
because <code>arguments</code> itself was a valid shape name.  Hence <code>insert into T from arguments</code> &quot;just works&quot;.  And so half
the rewrites were deleted.  The only cost was that the form <code>from arguments like shape</code> became the cursor form
<code>from arguments(like shape)</code> which only adds mandatory parens to a form that was largely unused anyway (there were two
cases in our entire codebase).  The cursor form is more general as you can do <code>from C(like A, like B)</code> to get the
fields that match <code>A</code> then those that match <code>B</code>.  Arguments get this for free as well (well, at the cost of parens).</p><p>So overall, this feature was added, and the compiler got smaller and cleaner.  Only the test suite had to grow.</p><p>Stay safe out there.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/facebook">facebook</a><a class="margin-horiz--sm" href="/blog/tags/cg-sql">cg-sql</a><a class="margin-horiz--sm" href="/blog/tags/errors">errors</a></div></footer></article><div><a href="https://github.com/facebookincubator/CG-SQL/edit/master/website/blog/blog/2020-12-08-arg-bundle-intro.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/virtual-table-into"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« Introducing Virtual Tables</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/declare-enum-intro"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Introducing Declare Enum Â»</div></a></div></nav></div></div><div class="col col--2"><div class="tableOfContents_3SO_"></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Learn</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/introduction">Getting Started</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://www.youtube.com/channel/UC2lTapw2Um90sZpGQVaynEg" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube</a></li><li class="footer__item"><a href="https://twitter.com/fbOpenSource" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Legal</h4><ul class="footer__items"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy</a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms</a></li></ul></div></div><div class="text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" target="_blank" rel="noopener noreferrer" class="footerLogoLink_1zJy"><img class="footer__logo" alt="Facebook Open Source Logo" src="/img/oss_logo.png"></a></div><div>Copyright Â© 2021 Facebook, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.480d1f30.js"></script>
<script src="/runtime~main.a1bfb077.js"></script>
<script src="/main.b815b31d.js"></script>
<script src="/1.2e95473d.js"></script>
<script src="/2.0c45b020.js"></script>
<script src="/3.d04889a6.js"></script>
<script src="/ccc49370.13cc85db.js"></script>
<script src="/390ec20d.a4317ec1.js"></script>
</body>
</html>